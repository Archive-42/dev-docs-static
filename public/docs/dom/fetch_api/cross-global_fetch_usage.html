<h1>Cross-global fetch usage</h1>

 <p class="summary">This article explains an edge case that occurs with fetch (and potentially other APIs exhibiting the same kind of resource retrieval behavior). When a cross-origin fetch involving a relative URL is initiated from an <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a>, the relative URL used to be resolved against the current global location, rather than the iframe's location.</p>
<h2 id="the_edge_case">The edge case</h2>
<p>Many sites will never come up against this edge case. To see it:</p> <ul> <li>You need a same-origin iframe</li> <li>That same-origin iframe needs to have a location with a different base URL</li> <li>You have to use the fetch function cross-global, e.g. <code>frame.contentWindow.fetch()</code>
</li> <li>The URL passed to fetch needs to be relative</li> </ul>
<h2 id="the_problem">The problem</h2>
<p>In the past we would resolve the relative URL against the current global, for example:</p> <pre data-language="js"><span class="token keyword">let</span> absolute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>relative<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span></pre> <p>This is not a problem as such. It is just that different APIs that exhibit this kind of behavior were doing it inconsistently with the behavior defined in the spec, which could lead to problems further down the line.</p>
<h2 id="the_solution">The solution</h2>
<p>In Firefox 60 onwards, Mozilla resolves the relative URL against the global that owns the <code>fetch()</code> function being used (see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1432272" rel=" noopener">bug 1432272</a>). So in the case described above, it is resolved against the iframe's location:</p> <pre data-language="js"><span class="token keyword">let</span> absolute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>relative<span class="token punctuation">,</span> frame<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span></pre> <p>There is a lot of discussion in progress about getting new specs to align with this behavior change, to mitigate potential problems going forward.</p>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Cross-global_fetch_usage" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Cross-global_fetch_usage</a>
  </p>
</div>
