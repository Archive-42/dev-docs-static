<h1>TextEncoder.prototype.encodeInto()</h1>

<div class="notecard experimental"> <strong id="experimental">Experimental</strong> <p><strong>This is an <a href="https://developer.mozilla.org/en-US/docs/MDN/Guidelines/Conventions_definitions#experimental">experimental technology</a></strong><br>Check the <a href="#browser_compatibility">Browser compatibility table</a> carefully before using this in production.</p> </div>
 <p>The <code>TextEncoder.prototype.encodeInto()</code> method takes a <a href="../usvstring"><code>USVString</code></a> to encode and a destination <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array"><code>Uint8Array</code></a> to put resulting UTF-8 encoded text into, and returns a dictionary object indicating the progress of the encoding. This is potentially more performant than the older <code>encode()</code> method especially when the target buffer is a view into a Wasm heap.</p>
<h2 id="syntax">Syntax</h2>
<pre data-language="js">b1 <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> uint8Array<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
<h3 id="parameters">Parameters</h3>
<dl> <dt><code><var>string</var></code></dt> <dd>Is a <a href="../usvstring"><code>USVString</code></a> containing the text to encode.</dd> <dt><code><var>uint8Array</var></code></dt> <dd>Is a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array"><code>Uint8Array</code></a> object instance to place the resulting UTF-8 encoded text into.</dd> </dl>
<h3 id="return_value">Return value</h3>
<p>A <code>TextEncoderEncodeIntoResult</code> dictionary, which contains two members:</p> <dl> <dt><code>read</code></dt> <dd>The number of UTF-16 units of code from the source that has been converted over to UTF-8. This may be less than <code>string.length</code> if <code>uint8Array</code> did not have enough space.</dd> <dt><code>written</code></dt> <dd>The number of bytes modified in the destination <code>Uint8Array</code>. The bytes written are guaranteed to form complete UTF-8 byte sequences.</dd> </dl>
<h2 id="encode_into_a_specific_position">Encode Into A Specific Position</h2>
<p><var>encoder</var>.encodeInto always puts its output at the start of the array. However, it is sometimes useful to make the output start at a particular index. The solution is <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/subarray">TypedArray.prototype.subarray()</a>. Observe.</p> <pre data-language="js"><span class="token keyword">var</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encodeIntoAtPosition</span><span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> u8array<span class="token punctuation">,</span> position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> encoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> position <span class="token operator">?</span> u8array<span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span>position<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> u8array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> u8array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">encodeIntoAtPosition</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> u8array<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">""</span> <span class="token operator">+</span> u8array<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0,0,104,101,108,108,111,0</span>
</pre>
<h2 id="buffer_sizing">Buffer Sizing</h2>
<p>To convert a JavaScript string <code>s</code>, the output space needed for full conversion is never less than <code>s.length</code> bytes and never greater than <code>s.length * 3</code> bytes. If the output allocation (typically within Wasm heap) is expected to be short-lived, it makes sense to allocate <code>s.length * 3</code> bytes for the output, in which case the first conversion attempt is guaranteed to convert the whole string. Note that the <code>s.length * 3</code> is rare because the string would have to be packed with some of the few characters that expant into 3 bytes. It is unlikely that long text will exceed <code>s.length * 2</code> bytes in length. Thus, a more optimistic approach might be to allocate <code>s.length * 2 + 5</code> bytes, and perform reallocation in the rare circumstance that the optimistic prediction was wrong. </p> <p>If the output is expected to be long-lived, it makes sense to compute minimum allocation <code>roundUpToBucketSize(s.length)</code>, the maximum allocation size <code>s.length * 3</code>, and to have a chosen (as a tradeoff between memory usage and speed) threshold <code>t</code> such that if <code>roundUpToBucketSize(s.length) + t &gt;= s.length * 3</code>, you allocate for <code>s.length * 3</code>. Otherwise, first allocate for <code>roundUpToBucketSize(s.length)</code> and convert. If the <code>read</code> item it the return dictionary is <code>s.length</code>, the conversion is done. If not, reallocate the target buffer to <code>written + (s.length - read) * 3</code> and then convert the rest by taking a substring of <code>s</code> starting from index <code>read</code> and a subbuffer of the target buffer starting from index <code>written</code>.</p> <p>Above <code>roundUpToBucketSize()</code> is a function that rounds up to the allocator bucket size. For example, if your Wasm allocator is known to use power-of-two buckets, <code>roundUpToBucketSize()</code> should return the argument if it is a power-of-two or the next power-of-two otherwise. If the behavior of the Wasm allocator is unknown, <code>roundUpToBucketSize()</code> should be an identity function.</p> <p>If the behavior of your allocator is unknown, you might want to have up to two reallocation steps and make the first reallocation step multiply the <em>remaining unconverted</em> length by two instead of three. However, in that case, it makes sense not to implement the usual multiplying by two of the <em>already written</em> buffer length, because in such a case if a second reallocation happened, it would always overallocate compared to the original length times three.The above advice assumes that you don't need to allocate space for a zero terminator. That is, on the Wasm side you are working with Rust strings or a non-zero-terminating C++ class. If you are working with C++ <code>std::string</code>, even though the logical length is shown to you, you need to take the extra terminator byte into account when computing rounding up to allocator bucket size. See the next section about C strings.</p>
<h2 id="no_zero-termination">No Zero-Termination</h2>
<p>If the input string contains the character U+0000 in the input, <code>encodeInto()</code> will write a 0x00 byte in the output. <code>encodeInto()</code> <em>does not</em> write a C-style 0x00 sentinel byte after the logical output.</p> <p>If your Wasm program uses C strings, it's your responsibility to write the 0x00 sentinel and you can't prevent your Wasm program from seeing a logically truncated string if the JavaScript string contained U+0000. Observe:</p> <pre data-language="js"><span class="token keyword">var</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encodeIntoWithSentinel</span><span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> u8array<span class="token punctuation">,</span> position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> stats <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> position <span class="token operator">?</span> u8array<span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span>position<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> u8array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>written <span class="token operator">&lt;</span> u8array<span class="token punctuation">.</span>length<span class="token punctuation">)</span> u8array<span class="token punctuation">[</span>stats<span class="token punctuation">.</span>written<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// append null if room</span>
    <span class="token keyword">return</span> stats<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>
<h2 id="examples">Examples</h2>
<pre data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>source<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>This is a sample paragraph.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></pre> <pre data-language="js"><span class="token keyword">const</span> sourcePara <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.source'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resultPara <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.result'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> string <span class="token operator">=</span> sourcePara<span class="token punctuation">.</span>textContent<span class="token punctuation">;</span>

<span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> utf8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> encodedResults <span class="token operator">=</span> textEncoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> utf8<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultPara<span class="token punctuation">.</span>textContent <span class="token operator">+=</span> <span class="token string">'Bytes read: '</span> <span class="token operator">+</span> encodedResults<span class="token punctuation">.</span>read <span class="token operator">+</span>
                          <span class="token string">' | Bytes written: '</span> <span class="token operator">+</span> encodedResults<span class="token punctuation">.</span>written <span class="token operator">+</span>
                          <span class="token string">' | Encoded result: '</span> <span class="token operator">+</span> utf8<span class="token punctuation">;</span></pre> <p><iframe class="sample-code-frame" id="frame_Examples" src="https://yari-demos.prod.mdn.mozit.cloud/en-US/docs/Web/API/TextEncoder/encodeInto/_samples_/Examples" loading="lazy"></iframe></p>
<h2 id="polyfill">Polyfill</h2>
<p>The polyfill below may be a bit long because of the switch cases and utilization of native TextEncoder.prototype.encode in Safari when available, but it is well worth the length because of the gains in performance.</p> <pre data-language="js"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token string">"use strict"</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> log <span class="token operator">=</span> Math<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">LN2</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">LN2</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> clz32 <span class="token operator">=</span> Math<span class="token punctuation">.</span>clz32 <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token number">31</span> <span class="token operator">-</span> <span class="token function">log</span><span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token constant">LN2</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> fromCharCode <span class="token operator">=</span> String<span class="token punctuation">.</span>fromCharCode<span class="token punctuation">;</span>
    <span class="token keyword">var</span> patchedU8Array <span class="token operator">=</span> window<span class="token punctuation">.</span>Uint8Array <span class="token operator">||</span> Array<span class="token punctuation">;</span>
    <span class="token keyword">var</span> TextEncoderPrototype <span class="token operator">=</span> TextEncoder<span class="token punctuation">[</span><span class="token string">"prototype"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> GlobalTextEncoder <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">"TextEncoder"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> globalTextEncoderPrototype<span class="token punctuation">;</span>
    <span class="token keyword">var</span> globalTextEncoderInstance<span class="token punctuation">;</span>
    <span class="token comment">//////////////////////////////////////////////////////////////////////////////////////</span>
    <span class="token keyword">function</span> <span class="token function">encoderReplacer</span><span class="token punctuation">(</span><span class="token parameter">nonAsciiChars</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// make the UTF string into a binary UTF-8 encoded string</span>
        <span class="token keyword">var</span> point <span class="token operator">=</span> nonAsciiChars<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0xD800</span> <span class="token operator">&lt;=</span> point <span class="token operator">&amp;&amp;</span> point <span class="token operator">&lt;=</span> <span class="token number">0xDBFF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> nextcode <span class="token operator">=</span> nonAsciiChars<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// defaults to 0 when NaN, causing null replacement character</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0xDC00</span> <span class="token operator">&lt;=</span> nextcode <span class="token operator">&amp;&amp;</span> nextcode <span class="token operator">&lt;=</span> <span class="token number">0xDFFF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//point = ((point - 0xD800)&lt;&lt;10) + nextcode - 0xDC00 + 0x10000|0;</span>
                point <span class="token operator">=</span> <span class="token punctuation">(</span>point<span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> nextcode <span class="token operator">-</span> <span class="token number">0x35fdc00</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point <span class="token operator">&gt;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token function">fromCharCode</span><span class="token punctuation">(</span>
                        <span class="token punctuation">(</span><span class="token number">0x1e</span><span class="token comment">/*0b11110*/</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token comment">/*0b10*/</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token comment">/*0b00111111*/</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token comment">/*0b10*/</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token comment">/*0b00111111*/</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token comment">/*0b10*/</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>point<span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token comment">/*0b00111111*/</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> point <span class="token operator">=</span> <span class="token number">65533</span><span class="token comment">/*0b1111111111111101*/</span><span class="token punctuation">;</span><span class="token comment">//return '\xEF\xBF\xBD';//fromCharCode(0xef, 0xbf, 0xbd);</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*if (point &lt;= 0x007f) return nonAsciiChars;
        else */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>point <span class="token operator">&lt;=</span> <span class="token number">0x07ff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x6</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>point<span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">fromCharCode</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token number">0xe</span><span class="token comment">/*0b1110*/</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token comment">/*0b10*/</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>point<span class="token operator">&gt;&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token comment">/*0b00111111*/</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token number">0x2</span><span class="token comment">/*0b10*/</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>point<span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token comment">/*0b00111111*/</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    TextEncoderPrototype<span class="token punctuation">[</span><span class="token string">"encode"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">inputString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0xc0 =&gt; 0b11000000; 0xff =&gt; 0b11111111; 0xc0-0xff =&gt; 0b11xxxxxx</span>
        <span class="token comment">// 0x80 =&gt; 0b10000000; 0xbf =&gt; 0b10111111; 0x80-0xbf =&gt; 0b10xxxxxx</span>
        <span class="token keyword">var</span> encodedString <span class="token operator">=</span> inputString <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span>  <span class="token string">""</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">+</span> inputString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> encoderReplacer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> len<span class="token operator">=</span>encodedString<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">patchedU8Array</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span>
            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> encodedString<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">polyfill_encodeInto</span><span class="token punctuation">(</span><span class="token parameter">inputString<span class="token punctuation">,</span> u8Arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> encodedString <span class="token operator">=</span> inputString <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span>  <span class="token string">""</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">+</span> inputString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> encoderReplacer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> len<span class="token operator">=</span>encodedString<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> char<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> read<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> u8ArrLen <span class="token operator">=</span> u8Arr<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">,</span> inputLength<span class="token operator">=</span>inputString<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u8ArrLen <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> len<span class="token operator">=</span>u8ArrLen<span class="token punctuation">;</span>
        putChars<span class="token operator">:</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            char <span class="token operator">=</span> encodedString<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>char <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
                    read <span class="token operator">=</span> read <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token comment">// extension points:</span>
                <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token number">13</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> u8ArrLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        read <span class="token operator">=</span> read <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">14</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> u8ArrLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        read <span class="token operator">=</span> read <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token number">15</span><span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> u8ArrLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        read <span class="token operator">=</span> read <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span> putChars<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//read = read + ((char &gt;&gt;&gt; 6) !== 2) |0;</span>
            u8Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> char<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"written"</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token operator">:</span> inputLength <span class="token operator">&lt;</span> read <span class="token operator">?</span> inputLength <span class="token operator">:</span> read<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    TextEncoderPrototype<span class="token punctuation">[</span><span class="token string">"encodeInto"</span><span class="token punctuation">]</span> <span class="token operator">=</span> polyfill_encodeInto<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>GlobalTextEncoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">[</span><span class="token string">"TextEncoder"</span><span class="token punctuation">]</span> <span class="token operator">=</span> TextEncoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>globalTextEncoderPrototype <span class="token operator">=</span> GlobalTextEncoder<span class="token punctuation">[</span><span class="token string">"prototype"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"encodeInto"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        globalTextEncoderInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GlobalTextEncoder</span><span class="token punctuation">;</span>
        globalTextEncoderPrototype<span class="token punctuation">[</span><span class="token string">"encodeInto"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">string<span class="token punctuation">,</span> u8arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Unfortunately, there's no way I can think of to quickly extract the number of bits written and the number of bytes read and such</span>
            <span class="token keyword">var</span> strLen <span class="token operator">=</span> string<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">,</span> u8Len <span class="token operator">=</span> u8arr<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>strLen <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u8Len <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// in most circumstances, this means its safe. there are still edge-cases which are possible</span>
                <span class="token comment">// in many circumstances, we can use the faster native TextEncoder</span>
                <span class="token keyword">var</span> res8 <span class="token operator">=</span> globalTextEncoderInstance<span class="token punctuation">[</span><span class="token string">"encode"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> res8Len <span class="token operator">=</span> res8<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res8Len <span class="token operator">&lt;</span> u8Len<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// if we dont have to worry about read/written</span>
                    u8arr<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span> res8 <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        <span class="token string">"read"</span><span class="token operator">:</span> strLen<span class="token punctuation">,</span>
                        <span class="token string">"written"</span><span class="token operator">:</span> res8<span class="token punctuation">.</span>length<span class="token operator">|</span><span class="token number">0</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">polyfill_encodeInto</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> u8arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> global <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">+</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">typeof</span> self <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">+</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> self <span class="token operator">:</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre> <p>Source: <a href="https://github.com/anonyco/FastestSmallestTextEncoderDecoder" rel=" noopener">https://github.com/anonyco/FastestSmallestTextEncoderDecoder</a> </p>
<h2 id="specifications">Specifications</h2>
<div class="_table"><table class="standard-table"> <tbody> <tr> <th scope="col">Specification</th> <th scope="col">Status</th> <th scope="col">Comment</th> </tr> <tr> <td><a href="https://encoding.spec.whatwg.org/#dom-textencoder-encodeinto" hreflang="en" rel=" noopener">Encoding<br><small>The definition of 'TextEncoder.encode()' in that specification.</small></a></td> <td><span class="spec-living">Living Standard</span></td> <td>Initial definition.</td> </tr> </tbody> </table></div>
<h2 id="browser_compatibility">Browser compatibility</h2>
<table>
<thead>
<tr id="bct-browser-type">
<th></th>
<th colspan="6">Desktop</th>
<th colspan="6">Mobile</th>
</tr>
<tr id="bct-browsers">
<th></th>
<th>Chrome</th>
<th>Edge</th>
<th>Firefox</th>
<th>Internet Explorer</th>
<th>Opera</th>
<th>Safari</th>
<th>WebView Android</th>
<th>Chrome Android</th>
<th>Firefox for Android</th>
<th>Opera Android</th>
<th>Safari on IOS</th>
<th>Samsung Internet</th>
</tr>
</thead>
<tbody><tr>
<th><code>encodeInto</code></th>
<td class="bc-supports-yes"><div>74</div></td>
<td class="bc-supports-yes"><div>79</div></td>
<td class="bc-supports-yes"><div>66</div></td>
<td class="bc-supports-no"><div>No</div></td>
<td class="bc-supports-no"><div>No</div></td>
<td class="bc-supports-yes"><div>14.1</div></td>
<td class="bc-supports-yes"><div>74</div></td>
<td class="bc-supports-yes"><div>74</div></td>
<td class="bc-supports-yes"><div>66</div></td>
<td class="bc-supports-no"><div>No</div></td>
<td class="bc-supports-yes"><div>14.5</div></td>
<td class="bc-supports-yes"><div>11.0</div></td>
</tr></tbody>
</table> 
 <h2 id="see_also">See also</h2>
<ul> <li>The <a href="../textencoder"><code>TextEncoder</code></a> interface it belongs to.</li> <li><a href="encode"><code>TextEncoder.encode()</code></a></li> </ul>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder/encodeInto" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder/encodeInto</a>
  </p>
</div>
