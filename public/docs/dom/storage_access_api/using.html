<h1>Using the Storage Access API</h1>
<div class="notecard experimental"> <strong id="experimental">Experimental</strong> <p><strong>This is an <a href="https://developer.mozilla.org/en-US/docs/MDN/Guidelines/Conventions_definitions#experimental">experimental technology</a></strong><br>Check the <a href="#browser_compatibility">Browser compatibility table</a> carefully before using this in production.</p> </div> <p class="summary">The <a href="../storage_access_api">Storage Access API</a> should be used by embedded cross-origin documents to verify whether they have access to their first-party storage and, if not, to request access. We’ll briefly look at a common storage access scenario.</p>
<h2 id="usage_notes">Usage notes</h2>
<p>The Storage Access API is designed to allow embedded content to request access to storage that would otherwise be blocked when a user’s browser is set to block all third-party cookies. Since embedded content won’t know which storage policy is in use by the user, it’s best to always check whether the embedded frame has storage access before attempting to read or write from storage. This is particularly true for <a href="../document/cookie"><code>Document.cookie</code></a> access, as browsers will often return an empty cookie jar when third-party cookies are blocked.</p>
<h2 id="accessing_a_user's_cookies_in_an_embedded_cross-origin_iframe">Accessing a user's cookies in an embedded cross-origin iframe</h2>
<p>In this example we show how an embedded cross-origin <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a> can access a user’s cookies under a storage access policy that blocks third-party cookies.</p> <p>First of all, if the <code>&lt;iframe&gt;</code> is sandboxed, the embedding website needs to add the <code>allow-storage-access-by-user-activation</code> <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox">sandbox token</a> to allow storage access requests to be successful, along with <code>allow-scripts</code> and <code>allow-same-origin</code> to allow it to call the API, and execute in an origin that can have cookies:</p> <pre data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">sandbox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allow-storage-access-by-user-activation
                 allow-scripts
                 allow-same-origin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span></pre> <p>Now on to the code executed inside the embedded document. Since it does not know whether it currently has access to storage, it should first call <a href="../document/hasstorageaccess"><code>Document.hasStorageAccess()</code></a>. If that call returns <code>false</code>, we can then call <a href="../document/requeststorageaccess"><code>Document.requestStorageAccess()</code></a>, returning the result so that then we can chain it onto the previous promise call. In the final <code>then</code>, we'll have first-party storage access.</p> <pre data-language="js">document<span class="token punctuation">.</span><span class="token function">hasStorageAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">hasAccess</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">requestStorageAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Now we have first-party storage access!</span>

  <span class="token comment">// Let's access some items from the first-party cookie jar</span>
  document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">"foo=bar"</span><span class="token punctuation">;</span>              <span class="token comment">// set a cookie</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// access a localStorage entry</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// error obtaining storage access.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre> <p>Note that access requests are automatically denied unless the embedded content is currently processing a user gesture such as a tap or click — so this code needs to be run inside some kind of user gesture-based event handler, for example:</p> <pre data-language="js">btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// run code here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage_Access_API/Using" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/Storage_Access_API/Using</a>
  </p>
</div>
